{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.1.42791",
      "templateHash": "11629311677016947433"
    }
  },
  "parameters": {
    "router_type": {
      "type": "string",
      "defaultValue": "TRIAGE_AGENT",
      "allowedValues": [
        "BYPASS",
        "CLU",
        "CQA",
        "ORCHESTRATION",
        "FUNCTION_CALLING",
        "TRIAGE_AGENT"
      ]
    },
    "gpt_model_name": {
      "type": "string",
      "allowedValues": [
        "gpt-4o-mini",
        "gpt-4o"
      ],
      "metadata": {
        "description": "Name of GPT model to deploy."
      }
    },
    "gpt_deployment_capacity": {
      "type": "int",
      "minValue": 1,
      "metadata": {
        "description": "Capacity of GPT model deployment."
      }
    },
    "gpt_deployment_type": {
      "type": "string",
      "allowedValues": [
        "Standard",
        "GlobalStandard"
      ],
      "metadata": {
        "description": "GPT model deployment type."
      }
    },
    "embedding_model_name": {
      "type": "string",
      "allowedValues": [
        "text-embedding-ada-002",
        "text-embedding-3-small"
      ],
      "metadata": {
        "description": "Name of Embedding model to deploy."
      }
    },
    "embedding_deployment_capacity": {
      "type": "int",
      "minValue": 1,
      "metadata": {
        "description": "Capacity of embedding model deployment."
      }
    },
    "embedding_deployment_type": {
      "type": "string",
      "allowedValues": [
        "Standard",
        "GlobalStandard"
      ],
      "metadata": {
        "description": "Embedding model deployment type."
      }
    }
  },
  "variables": {
    "suffix": "[uniqueString(subscription().id, resourceGroup().id, resourceGroup().location)]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_managed_identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "suffix": {
            "value": "[variables('suffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "18274542844136747680"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "metadata": {
                "description": "Resource name suffix."
              }
            },
            "name": {
              "type": "string",
              "defaultValue": "[format('id-{0}', parameters('suffix'))]",
              "metadata": {
                "description": "Name of Managed Identity resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "client_id": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_container_registry",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "suffix": {
            "value": "[variables('suffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "7820351141598382207"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "metadata": {
                "description": "Resource name suffix."
              }
            },
            "name": {
              "type": "string",
              "defaultValue": "[format('acr{0}', parameters('suffix'))]",
              "metadata": {
                "description": "Name of Container Registry resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2025-04-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_storage_account",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "suffix": {
            "value": "[variables('suffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "2075735219052995471"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "metadata": {
                "description": "Resource name suffix."
              }
            },
            "name": {
              "type": "string",
              "defaultValue": "[format('st{0}', parameters('suffix'))]",
              "metadata": {
                "description": "Name of Storage Account resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "blob_container_name": {
              "type": "string",
              "defaultValue": "contoso-outdoors-manuals",
              "metadata": {
                "description": "Blob container name."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', parameters('blob_container_name'))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "StorageV2",
              "properties": {
                "allowSharedKeyAccess": false,
                "allowBlobPublicAccess": false,
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              },
              "sku": {
                "name": "Standard_LRS"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "connection_string": {
              "type": "string",
              "value": "[format('ResourceId={0};', resourceId('Microsoft.Storage/storageAccounts', parameters('name')))]"
            },
            "blob_container_name": {
              "type": "string",
              "value": "[parameters('blob_container_name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_search_service",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "suffix": {
            "value": "[variables('suffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "12192345912996799704"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "metadata": {
                "description": "Resource name suffix."
              }
            },
            "name": {
              "type": "string",
              "defaultValue": "[format('srch-{0}', parameters('suffix'))]",
              "metadata": {
                "description": "Name of AI Search resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2024-06-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "disableLocalAuth": false,
                "semanticSearch": "free",
                "publicNetworkAccess": "enabled",
                "networkRuleSet": {
                  "bypass": "AzureServices",
                  "ipRules": []
                },
                "authOptions": {
                  "aadOrApiKey": {
                    "aadAuthFailureMode": "http401WithBearerChallenge"
                  }
                }
              },
              "sku": {
                "name": "basic"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[format('https://{0}.search.windows.net', parameters('name'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_ai_foundry",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "suffix": {
            "value": "[variables('suffix')]"
          },
          "managed_identity_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.name.value]"
          },
          "search_service_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_search_service'), '2022-09-01').outputs.name.value]"
          },
          "gpt_model_name": {
            "value": "[parameters('gpt_model_name')]"
          },
          "gpt_deployment_capacity": {
            "value": "[parameters('gpt_deployment_capacity')]"
          },
          "gpt_deployment_type": {
            "value": "[parameters('gpt_deployment_type')]"
          },
          "embedding_model_name": {
            "value": "[parameters('embedding_model_name')]"
          },
          "embedding_deployment_capacity": {
            "value": "[parameters('embedding_deployment_capacity')]"
          },
          "embedding_deployment_type": {
            "value": "[parameters('embedding_deployment_type')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "766634849886680321"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "metadata": {
                "description": "Resource name suffix."
              }
            },
            "name": {
              "type": "string",
              "defaultValue": "[format('aif-{0}', parameters('suffix'))]",
              "metadata": {
                "description": "Name of AI Foundry resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "agents_project_name": {
              "type": "string",
              "defaultValue": "[format('{0}-agents', parameters('name'))]",
              "metadata": {
                "description": "Agents AI Foundry project name."
              }
            },
            "gpt_model_name": {
              "type": "string",
              "metadata": {
                "description": "Name of GPT model to deploy."
              }
            },
            "gpt_deployment_capacity": {
              "type": "int",
              "minValue": 1,
              "metadata": {
                "description": "Capacity of GPT model deployment."
              }
            },
            "gpt_deployment_type": {
              "type": "string",
              "allowedValues": [
                "Standard",
                "GlobalStandard"
              ]
            },
            "embedding_model_name": {
              "type": "string",
              "metadata": {
                "description": "Name of embedding model to deploy."
              }
            },
            "embedding_deployment_capacity": {
              "type": "int",
              "minValue": 1,
              "metadata": {
                "description": "Capacity of embedding model deployment."
              }
            },
            "embedding_model_dimensions": {
              "type": "int",
              "defaultValue": 1536,
              "metadata": {
                "description": "Model dimensions of embedding model to deploy."
              }
            },
            "embedding_deployment_type": {
              "type": "string",
              "allowedValues": [
                "Standard",
                "GlobalStandard"
              ]
            },
            "search_service_name": {
              "type": "string",
              "metadata": {
                "description": "Name of AI Search resource"
              }
            },
            "managed_identity_name": {
              "type": "string",
              "metadata": {
                "description": "Name of managed identity to use for Container Apps."
              }
            }
          },
          "variables": {
            "language_endpoint_key": "Language"
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), parameters('agents_project_name'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')))]": {}
                }
              },
              "properties": {},
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), parameters('gpt_model_name'))]",
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('gpt_model_name')]"
                }
              },
              "sku": {
                "name": "[parameters('gpt_deployment_type')]",
                "capacity": "[parameters('gpt_deployment_capacity')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), parameters('embedding_model_name'))]",
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('embedding_model_name')]"
                }
              },
              "sku": {
                "name": "[parameters('embedding_deployment_type')]",
                "capacity": "[parameters('embedding_deployment_capacity')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', parameters('name'), parameters('gpt_model_name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-04-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "AIServices",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "allowProjectManagement": true,
                "disableLocalAuth": true,
                "customSubDomainName": "[parameters('name')]",
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow"
                },
                "apiProperties": {
                  "qnaAzureSearchEndpointId": "[resourceId('Microsoft.Search/searchServices', parameters('search_service_name'))]",
                  "qnaAzureSearchEndpointKey": "[listAdminKeys(resourceId('Microsoft.Search/searchServices', parameters('search_service_name')), '2023-11-01').primaryKey]"
                }
              },
              "sku": {
                "name": "S0"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "agents_project_endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('name'), parameters('agents_project_name')), '2025-04-01-preview').endpoints['AI Foundry API']]"
            },
            "language_endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2025-04-01-preview').endpoints[variables('language_endpoint_key')]]"
            },
            "openai_endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2025-04-01-preview').endpoints['OpenAI Language Model Instance API']]"
            },
            "gpt_deployment_name": {
              "type": "string",
              "value": "[parameters('gpt_model_name')]"
            },
            "embedding_deployment_name": {
              "type": "string",
              "value": "[parameters('embedding_model_name')]"
            },
            "embedding_model_name": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/deployments', parameters('name'), parameters('embedding_model_name')), '2025-04-01-preview').model.name]"
            },
            "embedding_model_dimensions": {
              "type": "int",
              "value": "[parameters('embedding_model_dimensions')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy_managed_identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_search_service')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "create_role_assignments",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managed_identity_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.name.value]"
          },
          "container_registry_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_container_registry'), '2022-09-01').outputs.name.value]"
          },
          "ai_foundry_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry'), '2022-09-01').outputs.name.value]"
          },
          "search_service_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_search_service'), '2022-09-01').outputs.name.value]"
          },
          "storage_account_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_storage_account'), '2022-09-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "12803290937494767286"
            }
          },
          "parameters": {
            "managed_identity_name": {
              "type": "string",
              "metadata": {
                "description": "Name of Managed Identity resource."
              }
            },
            "container_registry_name": {
              "type": "string",
              "metadata": {
                "description": "Name of Container Registry resource."
              }
            },
            "storage_account_name": {
              "type": "string",
              "metadata": {
                "description": "Name of Storage Account resource."
              }
            },
            "ai_foundry_name": {
              "type": "string",
              "metadata": {
                "description": "Name of AI Foundry resource."
              }
            },
            "search_service_name": {
              "type": "string",
              "metadata": {
                "description": "Name of Search Service resource."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('container_registry_name'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('container_registry_name')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), resourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storage_account_name'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storage_account_name')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storage_account_name'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storage_account_name')), resourceId('Microsoft.Search/searchServices', parameters('search_service_name')), resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.Search/searchServices', parameters('search_service_name')), '2023-11-01', 'full').identity.principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('search_service_name'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('search_service_name')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), resourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('search_service_name'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('search_service_name')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), resourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('search_service_name'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('search_service_name')), resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), resourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), '2025-04-01-preview', 'full').identity.principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('ai_foundry_name'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), resourceId('Microsoft.Authorization/roleDefinitions', 'a001fd3d-188f-4b5d-821b-7da978bf7442'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'a001fd3d-188f-4b5d-821b-7da978bf7442')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('ai_foundry_name'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), resourceId('Microsoft.Authorization/roleDefinitions', 'f07febfe-79bc-46b1-8b37-790e26e6e498'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'f07febfe-79bc-46b1-8b37-790e26e6e498')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('ai_foundry_name'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), resourceId('Microsoft.Authorization/roleDefinitions', 'f07febfe-79bc-46b1-8b37-790e26e6e498'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), '2025-04-01-preview', 'full').identity.principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'f07febfe-79bc-46b1-8b37-790e26e6e498')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('ai_foundry_name'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), resourceId('Microsoft.Authorization/roleDefinitions', 'e47c6f54-e4a2-4754-9501-8e0985b135e1'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e47c6f54-e4a2-4754-9501-8e0985b135e1')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('ai_foundry_name'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), resourceId('Microsoft.Authorization/roleDefinitions', '53ca6127-db72-4b80-b1b0-d745d6d5456d'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managed_identity_name')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '53ca6127-db72-4b80-b1b0-d745d6d5456d')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('ai_foundry_name'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('ai_foundry_name')), resourceId('Microsoft.Search/searchServices', parameters('search_service_name')), resourceId('Microsoft.Authorization/roleDefinitions', 'a001fd3d-188f-4b5d-821b-7da978bf7442'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.Search/searchServices', parameters('search_service_name')), '2023-11-01', 'full').identity.principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'a001fd3d-188f-4b5d-821b-7da978bf7442')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('managed_identity_name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_container_registry')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_managed_identity')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_search_service')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_storage_account')]"
      ]
    }
  ],
  "outputs": {
    "LOCATION": {
      "type": "string",
      "value": "[resourceGroup().location]"
    },
    "RG_NAME": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "RG_SUFFIX": {
      "type": "string",
      "value": "[variables('suffix')]"
    },
    "USE_MI_AUTH": {
      "type": "string",
      "value": "true"
    },
    "MI_ID": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.id.value]"
    },
    "MI_CLIENT_ID": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.client_id.value]"
    },
    "LANGUAGE_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry'), '2022-09-01').outputs.language_endpoint.value]"
    },
    "CLU_PROJECT_NAME": {
      "type": "string",
      "value": "conv-agent-clu"
    },
    "CLU_MODEL_NAME": {
      "type": "string",
      "value": "clu-m1"
    },
    "CLU_DEPLOYMENT_NAME": {
      "type": "string",
      "value": "clu-m1-d1"
    },
    "CLU_CONFIDENCE_THRESHOLD": {
      "type": "string",
      "value": "0.5"
    },
    "CQA_PROJECT_NAME": {
      "type": "string",
      "value": "conv-agent-cqa"
    },
    "CQA_DEPLOYMENT_NAME": {
      "type": "string",
      "value": "production"
    },
    "CQA_CONFIDENCE_THRESHOLD": {
      "type": "string",
      "value": "0.5"
    },
    "ORCHESTRATION_PROJECT_NAME": {
      "type": "string",
      "value": "conv-agent-orch"
    },
    "ORCHESTRATION_MODEL_NAME": {
      "type": "string",
      "value": "orch-m1"
    },
    "ORCHESTRATION_DEPLOYMENT_NAME": {
      "type": "string",
      "value": "orch-m1-d1"
    },
    "ORCHESTRATION_CONFIDENCE_THRESHOLD": {
      "type": "string",
      "value": "0.5"
    },
    "PII_ENABLED": {
      "type": "string",
      "value": "true"
    },
    "PII_CATEGORIES": {
      "type": "string",
      "value": "organization,person"
    },
    "PII_CONFIDENCE_THRESHOLD": {
      "type": "string",
      "value": "0.5"
    },
    "AOAI_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry'), '2022-09-01').outputs.openai_endpoint.value]"
    },
    "AOAI_DEPLOYMENT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry'), '2022-09-01').outputs.gpt_deployment_name.value]"
    },
    "EMBEDDING_DEPLOYMENT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry'), '2022-09-01').outputs.embedding_deployment_name.value]"
    },
    "EMBEDDING_MODEL_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry'), '2022-09-01').outputs.embedding_model_name.value]"
    },
    "EMBEDDING_MODEL_DIMENSIONS": {
      "type": "string",
      "value": "[string(reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry'), '2022-09-01').outputs.embedding_model_dimensions.value)]"
    },
    "AGENTS_PROJECT_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_foundry'), '2022-09-01').outputs.agents_project_endpoint.value]"
    },
    "MAX_AGENT_RETRY": {
      "type": "string",
      "value": "3"
    },
    "DELETE_OLD_AGENTS": {
      "type": "string",
      "value": "true"
    },
    "SEARCH_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_search_service'), '2022-09-01').outputs.endpoint.value]"
    },
    "SEARCH_INDEX_NAME": {
      "type": "string",
      "value": "conv-agent-manuals-idx"
    },
    "STORAGE_ACCOUNT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_storage_account'), '2022-09-01').outputs.name.value]"
    },
    "STORAGE_ACCOUNT_CONNECTION_STRING": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_storage_account'), '2022-09-01').outputs.connection_string.value]"
    },
    "BLOB_CONTAINER_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_storage_account'), '2022-09-01').outputs.blob_container_name.value]"
    },
    "ACR_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_container_registry'), '2022-09-01').outputs.name.value]"
    },
    "ROUTER_TYPE": {
      "type": "string",
      "value": "[parameters('router_type')]"
    }
  }
}